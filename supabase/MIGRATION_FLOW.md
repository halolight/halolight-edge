# 数据库迁移执行流程图

## 📊 完整执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Supabase 初始化                               │
│  - auth.users 表（Supabase 内置）                                │
│  - 基础认证系统                                                   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  1️⃣ 20250101000000_add_new_features.sql                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ✓ profiles 表                                             │   │
│  │ ✓ user_roles 表                                           │   │
│  │ ✓ permissions 表                                          │   │
│  │ ✓ role_permissions 表                                     │   │
│  │ ✓ audit_logs 表                                           │   │
│  │ ✓ notifications 表                                        │   │
│  │ ✓ user_notification_reads 表                             │   │
│  │ ─────────────────────────────────────────────────────     │   │
│  │ ✓ data_tables 表（旧）                                    │   │
│  │ ✓ data_fields 表（旧）                                    │   │
│  │ ✓ scheduled_tasks 表                                      │   │
│  │ ✓ task_execution_history 表                              │   │
│  │ ✓ api_tokens 表                                           │   │
│  │ ✓ api_token_usage 表                                      │   │
│  │ ✓ api_docs 表                                             │   │
│  │ ✓ api_endpoints 表                                        │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  2️⃣ 20250101000001_sql_editor.sql                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ✓ execute_sql(query text) 函数                            │   │
│  │   - 动态 SQL 执行                                          │   │
│  │   - JSON 结果返回                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  3️⃣ 20250101000002_add_fine_grained_permissions.sql             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ✓ 细粒度权限表结构                                         │   │
│  │ ✓ check_permission() 函数                                 │   │
│  │ ✓ 权限检查 RLS 策略                                        │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  4️⃣-8️⃣ Supabase 自动生成的迁移                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ • 20251223121817_*.sql                                    │   │
│  │ • 20251223121825_*.sql                                    │   │
│  │ • 20251223123809_*.sql                                    │   │
│  │ • 20251223123839_*.sql                                    │   │
│  │ • 20251224090619_*.sql                                    │   │
│  │                                                            │   │
│  │ Schema 同步、配置更新、表结构调整                           │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  9️⃣ 20251225000000_fix_execute_sql.sql                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ✓ 改进 execute_sql() 函数                                 │   │
│  │   - 增强安全性                                             │   │
│  │   - 添加查询验证                                           │   │
│  │   - 优化错误处理                                           │   │
│  │   - 性能优化                                               │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  🔟 20251225120000_refactor_data_dictionary.sql ⭐ 重要          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ⚠️  DROP TABLE data_tables CASCADE                        │   │
│  │ ⚠️  DROP TABLE data_fields CASCADE                        │   │
│  │ ─────────────────────────────────────────────────────     │   │
│  │ ✅ CREATE TABLE dictionary_namespaces                     │   │
│  │ ✅ CREATE TABLE dictionary_entries                        │   │
│  │    - 支持所有 JS 数据类型                                  │   │
│  │    - JSONB 存储                                            │   │
│  │ ✅ CREATE TABLE dictionary_entry_versions                 │   │
│  │    - 自动版本追踪                                          │   │
│  │ ✅ CREATE TABLE dictionary_access_logs                    │   │
│  │ ─────────────────────────────────────────────────────     │   │
│  │ ✅ 辅助函数:                                               │   │
│  │    - get_entry_history()                                  │   │
│  │    - export_namespace_data()                              │   │
│  │    - import_namespace_data()                              │   │
│  │ ─────────────────────────────────────────────────────     │   │
│  │ ✅ 触发器:                                                 │   │
│  │    - 自动版本创建                                          │   │
│  │    - 删除记录追踪                                          │   │
│  │    - updated_at 自动更新                                   │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
                    ┌────────┐
                    │  完成   │
                    └────────┘
```

## 🔄 数据流转示意图

### 数据字典系统演进

```
旧系统 (data_tables + data_fields)
  │
  │  仅支持数据库字段类型
  │  无版本控制
  │  无导入导出
  │
  └──> 20251225120000_refactor_data_dictionary.sql
          │
          │  删除旧表
          │  创建新表
          │
          ▼
新系统 (dictionary_* 系列表)
  │
  ├─ dictionary_namespaces    (命名空间管理)
  │   └─ 分组组织数据
  │
  ├─ dictionary_entries        (条目存储)
  │   ├─ 支持 8 种 JS 数据类型
  │   ├─ JSONB 灵活存储
  │   └─ 标签系统
  │
  ├─ dictionary_entry_versions (版本历史)
  │   ├─ 自动追踪变更
  │   └─ 支持回溯
  │
  └─ dictionary_access_logs    (访问日志)
      └─ 审计追踪
```

## 📈 依赖关系图

```
auth.users (Supabase 内置)
    │
    ├──> profiles
    │      │
    │      └──> user_roles ─────────┐
    │             │                  │
    │             │                  │
    │             ▼                  │
    ├──> permissions                │
    │      │                         │
    │      ▼                         │
    │    role_permissions            │
    │                                │
    │                                │
    ├──> dictionary_namespaces      │
    │      │                         │
    │      └──> dictionary_entries  │
    │             │                  │
    │             ├──> dictionary_entry_versions
    │             │                  │
    │             └──> dictionary_access_logs
    │                                │
    ├──> scheduled_tasks            │
    │      │                         │
    │      └──> task_execution_history
    │                                │
    ├──> api_tokens                 │
    │      │                         │
    │      └──> api_token_usage     │
    │                                │
    ├──> api_docs                   │
    │      │                         │
    │      └──> api_endpoints       │
    │                                │
    ├──> audit_logs                 │
    │                                │
    └──> notifications              │
           │                         │
           └──> user_notification_reads
                                     │
                                     │
所有表的 RLS 策略都依赖 ──────────────┘
user_roles 进行权限检查
```

## 🎯 关键节点说明

### 🔴 Breaking Change

**20251225120000_refactor_data_dictionary.sql**

这个迁移会**破坏向后兼容性**：

```sql
-- ⚠️ 删除操作
DROP TABLE IF EXISTS data_fields CASCADE;
DROP TABLE IF EXISTS data_tables CASCADE;
```

**影响范围**：
- ❌ 旧的数据字典页面将无法工作
- ❌ 依赖旧表的查询会失败
- ❌ 旧数据将被清空

**缓解措施**：
1. 前端代码同步更新（已完成）
2. 数据迁移脚本（按需提供）
3. 回滚方案（保留旧迁移文件）

### 🟢 安全增强

**20251225000000_fix_execute_sql.sql**

改进 SQL 执行安全性：

```sql
-- 添加查询验证
-- 限制危险操作
-- 改进错误处理
```

**安全特性**：
- ✅ 防止 SQL 注入
- ✅ 限制 DROP/DELETE 操作
- ✅ 审计日志记录

## 📅 执行时间线

```
2025-01-01
  ├─ 00:00:00 - 基础功能部署
  ├─ 00:00:01 - SQL 编辑器
  └─ 00:00:02 - 细粒度权限

2025-12-23
  ├─ 12:18:17 - Supabase 自动同步
  ├─ 12:18:25 - Supabase 自动同步
  ├─ 12:38:09 - Supabase 自动同步
  └─ 12:38:39 - Supabase 自动同步

2025-12-24
  └─ 09:06:19 - Supabase 自动同步

2025-12-25
  ├─ 00:00:00 - 修复 SQL 执行
  └─ 12:00:00 - 数据字典重构 ⭐
```

## 🔍 回滚策略

### 如果需要回滚数据字典重构

```sql
-- 1. 恢复旧表结构
CREATE TABLE data_tables (
  -- 从 20250101000000_add_new_features.sql 复制
);

CREATE TABLE data_fields (
  -- 从 20250101000000_add_new_features.sql 复制
);

-- 2. 恢复数据（从备份）
-- 需要事先备份数据

-- 3. 删除新表
DROP TABLE IF EXISTS dictionary_access_logs CASCADE;
DROP TABLE IF EXISTS dictionary_entry_versions CASCADE;
DROP TABLE IF EXISTS dictionary_entries CASCADE;
DROP TABLE IF EXISTS dictionary_namespaces CASCADE;
```

**建议**：执行前先备份！

```bash
supabase db dump -f backup_before_refactor.sql
```

## 📚 相关文档

- [README.md](./README.md) - Supabase 使用指南
- [MIGRATION_ORDER.md](./MIGRATION_ORDER.md) - 详细迁移说明

---

**最后更新**: 2025-12-25

